---
/**
 * ParallaxBackground Component
 * Animated background shapes that move with scroll
 */
interface Props {
  variant?: 'blob' | 'circle' | 'gradient' | 'grid' | 'dots'
  color?: 'blue' | 'purple' | 'pink' | 'cyan' | 'green'
  position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center'
  size?: 'sm' | 'md' | 'lg' | 'xl'
  speed?: number
  class?: string
}

const { 
  variant = 'blob',
  color = 'blue',
  position = 'top-right',
  size = 'md',
  speed = 0.5,
  class: className = ''
} = Astro.props

const sizeMap = {
  sm: 300,
  md: 500,
  lg: 800,
  xl: 1200
}

const shapeSize = sizeMap[size]
---

<div 
  class={`parallax-bg parallax-bg-${position} parallax-bg-${color} parallax-bg-${variant} ${className}`}
  data-speed={speed}
  data-variant={variant}
  style={`--shape-size: ${shapeSize}px;`}
>
  {variant === 'blob' && (
    <svg class="parallax-shape" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <path class="blob-shape" d="M47.1,-57.8C59.9,-49.6,68.4,-33.1,71.3,-16.1C74.2,0.9,71.5,18.4,63.3,32.7C55.1,47,41.4,58.1,25.5,64.8C9.6,71.5,-8.5,73.8,-24.3,68.9C-40.1,64,-53.6,52,-62.3,37.1C-71,22.2,-74.9,4.4,-72.1,-12.3C-69.3,-29,-59.8,-44.6,-46.7,-52.7C-33.6,-60.8,-16.8,-61.4,0.5,-62C17.8,-62.6,35.7,-63.2,47.1,-57.8Z" />
    </svg>
  )}
  
  {variant === 'circle' && (
    <div class="parallax-shape circle-shape"></div>
  )}
  
  {variant === 'gradient' && (
    <div class="parallax-shape gradient-shape"></div>
  )}
  
  {variant === 'grid' && (
    <div class="parallax-shape grid-shape">
      <div class="grid-lines"></div>
    </div>
  )}
  
  {variant === 'dots' && (
    <div class="parallax-shape dots-shape"></div>
  )}
</div>

<script>
  function initParallax() {
    const parallaxElements = document.querySelectorAll('.parallax-bg')
    
    function updateParallax() {
      parallaxElements.forEach((element) => {
        const htmlElement = element as HTMLElement
        const speed = parseFloat(htmlElement.dataset.speed || '0.5')
        const rect = htmlElement.getBoundingClientRect()
        const scrolled = window.scrollY
        
        // Calculate parallax based on element position
        const elementTop = rect.top + scrolled
        const windowHeight = window.innerHeight
        const elementVisible = (scrolled + windowHeight) > elementTop && scrolled < (elementTop + rect.height)
        
        if (elementVisible) {
          const scrollProgress = (scrolled - elementTop + windowHeight) / (windowHeight + rect.height)
          const movement = (scrollProgress - 0.5) * 100 * speed
          const scale = 1 + (Math.abs(scrollProgress - 0.5) * 0.2)
          const rotation = (scrollProgress - 0.5) * 20 * speed
          
          const shape = htmlElement.querySelector('.parallax-shape') as HTMLElement
          if (shape) {
            shape.style.transform = `translate(${movement}px, ${-movement * 0.5}px) scale(${scale}) rotate(${rotation}deg)`
          }
        }
      })
    }
    
    // Throttle scroll events for performance
    let ticking = false
    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateParallax()
          ticking = false
        })
        ticking = true
      }
    }
    
    window.addEventListener('scroll', onScroll, { passive: true })
    updateParallax() // Initial call
  }

  // Initialize on load and page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initParallax)
  } else {
    initParallax()
  }

  document.addEventListener('astro:page-load', initParallax)
  document.addEventListener('astro:after-swap', initParallax)
</script>

<style lang="scss">
  .parallax-bg {
    position: absolute;
    width: var(--shape-size);
    height: var(--shape-size);
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
    
    &.parallax-bg-top-left {
      top: -20%;
      left: -10%;
    }
    
    &.parallax-bg-top-right {
      top: -20%;
      right: -10%;
    }
    
    &.parallax-bg-bottom-left {
      bottom: -20%;
      left: -10%;
    }
    
    &.parallax-bg-bottom-right {
      bottom: -20%;
      right: -10%;
    }
    
    &.parallax-bg-center {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  }
  
  .parallax-shape {
    width: 100%;
    height: 100%;
    transition: transform 0.1s ease-out;
    will-change: transform;
  }
  
  /* Blob Shape */
  .blob-shape {
    fill: currentColor;
    animation: blobMorph 20s ease-in-out infinite;
  }
  
  @keyframes blobMorph {
    0%, 100% {
      d: path("M47.1,-57.8C59.9,-49.6,68.4,-33.1,71.3,-16.1C74.2,0.9,71.5,18.4,63.3,32.7C55.1,47,41.4,58.1,25.5,64.8C9.6,71.5,-8.5,73.8,-24.3,68.9C-40.1,64,-53.6,52,-62.3,37.1C-71,22.2,-74.9,4.4,-72.1,-12.3C-69.3,-29,-59.8,-44.6,-46.7,-52.7C-33.6,-60.8,-16.8,-61.4,0.5,-62C17.8,-62.6,35.7,-63.2,47.1,-57.8Z");
    }
    33% {
      d: path("M43.3,-54.9C54.4,-45.5,60.3,-30.2,64.7,-14.2C69.1,1.8,72,18.5,66.4,32.1C60.8,45.7,46.7,56.2,31.2,62.2C15.7,68.2,-1.2,69.7,-17.5,65.9C-33.8,62.1,-49.5,53,-58.8,39.2C-68.1,25.4,-71,6.9,-68.3,-10.5C-65.6,-27.9,-57.3,-44.2,-44.8,-53.3C-32.3,-62.4,-16.2,-64.3,0.3,-64.7C16.8,-65.1,33.6,-64.1,43.3,-54.9Z");
    }
    66% {
      d: path("M39.2,-50.8C49.8,-42.3,56.7,-28.9,59.8,-14.8C62.9,-0.7,62.2,14.1,55.9,26.3C49.6,38.5,37.7,48.1,24.1,54.2C10.5,60.3,-4.8,63,-18.7,59.9C-32.6,56.8,-45.1,47.9,-53.5,35.8C-61.9,23.7,-66.2,8.4,-64.8,-6.3C-63.4,-21,-56.3,-35.1,-45.5,-43.3C-34.7,-51.5,-20.2,-53.8,-5.9,-56.1C8.4,-58.4,16.8,-60.7,39.2,-50.8Z");
    }
  }
  
  /* Circle Shape */
  .circle-shape {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: currentColor;
    filter: blur(60px);
    opacity: 0.3;
  }
  
  /* Gradient Shape */
  .gradient-shape {
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at center, currentColor 0%, transparent 70%);
    opacity: 0.15;
    filter: blur(40px);
  }
  
  /* Grid Shape */
  .grid-shape {
    width: 100%;
    height: 100%;
    opacity: 0.1;
    
    .grid-lines {
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(currentColor 1px, transparent 1px),
        linear-gradient(90deg, currentColor 1px, transparent 1px);
      background-size: 50px 50px;
    }
  }
  
  /* Dots Shape */
  .dots-shape {
    width: 100%;
    height: 100%;
    background-image: radial-gradient(currentColor 2px, transparent 2px);
    background-size: 30px 30px;
    opacity: 0.2;
  }
  
  /* Color Variants */
  .parallax-bg-blue {
    color: rgb(59, 130, 246);
  }
  
  .parallax-bg-purple {
    color: rgb(147, 51, 234);
  }
  
  .parallax-bg-pink {
    color: rgb(236, 72, 153);
  }
  
  .parallax-bg-cyan {
    color: rgb(6, 182, 212);
  }
  
  .parallax-bg-green {
    color: rgb(34, 197, 94);
  }
  
  /* Retro Mode Adjustments */
  :global(.retro-mode) {
    .parallax-bg-blue {
      color: var(--terminal-cyan);
    }
    
    .parallax-bg-purple,
    .parallax-bg-pink {
      color: var(--terminal-pink);
    }
    
    .parallax-bg-cyan {
      color: var(--terminal-cyan);
    }
    
    .circle-shape,
    .gradient-shape {
      opacity: 0.15;
      filter: blur(80px);
    }
    
    .grid-shape,
    .dots-shape {
      opacity: 0.15;
    }
  }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    .parallax-bg {
      width: calc(var(--shape-size) * 0.6);
      height: calc(var(--shape-size) * 0.6);
    }
    
    .blob-shape {
      animation-duration: 15s;
    }
  }
</style>

